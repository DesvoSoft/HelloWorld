---
// BtcTracker.astro
---

<div class="btc-tracker-container">
  <div class="btc-tracker-card" id="btc-tracker">
    <div class="tracker-header">
      <div class="coin-info">
        <div class="coin-icon">
          <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="16" fill="#F7931A"/>
            <path d="M23.189 14.022c.336-2.247-1.374-3.455-3.712-4.26l.759-3.041-1.85-.461-.74 2.965c-.486-.121-.984-.235-1.478-.348l.746-2.989-1.85-.461-.759 3.041c-.403-.092-.801-.182-1.188-.276l.001-.005-2.552-.637-.492 1.976s1.373.315 1.344.334c.75.187.885.683.863 1.077l-.864 3.465c.052.013.119.032.193.058l-.195-.049-1.21 4.853c-.092.228-.325.57-.849.44.02.029-1.344-.334-1.344-.334l-.918 2.117 2.408.6c.447.112.885.228 1.316.339l-.766 3.075 1.85.461.759-3.042c.505.137 1 .267 1.487.39l-.754 3.027 1.85.461.766-3.074c3.156.598 5.528.357 6.526-2.498.805-2.298-.04-3.624-1.701-4.493 1.21-.28 2.12-1.077 2.362-2.724zM19.16 20.43c-.572 2.298-4.439 1.056-5.694.744l1.016-4.074c1.255.313 5.276.932 4.678 3.33zm.573-5.753c-.522 2.092-3.742 1.03-4.787.77l.922-3.698c1.045.26 4.408.746 3.865 2.928z" fill="white"/>
          </svg>
        </div>
        <span class="coin-name">Bitcoin</span>
        <span class="coin-symbol">BTC</span>
      </div>
      <div class="live-indicator">
        <span class="dot"></span>
        LIVE
      </div>
    </div>
    
    <div class="time-range-selector">
      <div class="time-range-buttons">
        <button class="time-range-btn active" data-range="24h">24h</button>
        <button class="time-range-btn" data-range="7d">7d</button>
        <button class="time-range-btn" data-range="30d">30d</button>
        <button class="time-range-btn" data-range="1y">1y</button>
      </div>
    </div>

    <div class="price-container">
      <div class="current-price" id="btc-price">Loading...</div>
      <div class="price-change" id="btc-change">
        <span class="change-value">--</span>
      </div>
    </div>

    <div class="graph-container">
      <div id="btc-chart-container">
        <div style="display: flex; align-items: center; justify-content: center; height: 140px; color: #cbd6e6; font-size: 0.9rem;">
          Loading chart...
        </div>
      </div>
    </div>

    <div class="tracker-footer">
      <span class="last-updated">Last updated: <span id="update-time">--</span></span>
    </div>
  </div>
</div>

<style>
  .btc-tracker-container {
    display: flex;
    justify-content: center;
    width: 100%;
    margin: 2rem 0;
  }

  .btc-tracker-card {
    background: rgba(11, 27, 52, 0.95);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(76, 157, 245, 0.3);
    border-radius: 20px;
    padding: 2rem;
    width: 100%;
    max-width: 380px;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    box-shadow: 0 15px 45px 0 rgba(0, 0, 0, 0.5);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }

  .btc-tracker-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 25px 60px 0 rgba(0, 0, 0, 0.6);
    border-color: rgba(76, 157, 245, 0.5);
  }

  .tracker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
  }

  .coin-info {
    display: flex;
    align-items: center;
    gap: 0.85rem;
  }

  .coin-name {
    font-weight: 700;
    color: #f1f7ff;
    font-size: 1.2rem;
    letter-spacing: -0.01em;
  }

  .coin-symbol {
    color: #cbd6e6;
    font-size: 0.9rem;
    font-weight: 600;
    background: rgba(76, 157, 245, 0.15);
    padding: 0.1rem 0.5rem;
    border-radius: 6px;
  }

  .live-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    font-weight: 800;
    color: #4c9df5;
    background: rgba(76, 157, 245, 0.15);
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    letter-spacing: 0.08em;
    border: 1px solid rgba(76, 157, 245, 0.3);
  }

  .dot {
    width: 8px;
    height: 8px;
    background-color: #4c9df5;
    border-radius: 50%;
    display: inline-block;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 157, 245, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(76, 157, 245, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 157, 245, 0); }
  }

  .price-container {
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .current-price {
    font-size: 2.5rem;
    font-weight: 800;
    color: #f1f7ff;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .price-change {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 1rem;
    font-weight: 700;
    margin-top: 0.5rem;
    padding: 0.2rem 0.6rem;
    border-radius: 8px;
  }

  .price-change.up { color: #4ade80; background: rgba(74, 222, 128, 0.15); }
  .price-change.down { color: #f87171; background: rgba(248, 113, 113, 0.15); }

  .time-range-selector {
    margin: 1rem 0;
    text-align: center;
  }

  .time-range-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .time-range-btn {
    background: rgba(76, 157, 245, 0.1);
    border: 1px solid rgba(76, 157, 245, 0.2);
    color: #cbd6e6;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }

  .time-range-btn:hover {
    background: rgba(76, 157, 245, 0.2);
    border-color: rgba(76, 157, 245, 0.4);
    color: #f1f7ff;
    transform: translateY(-1px);
  }

  .time-range-btn.active {
    background: rgba(76, 157, 245, 0.3);
    border-color: #4c9df5;
    color: #f1f7ff;
    box-shadow: 0 2px 8px rgba(76, 157, 245, 0.2);
  }

  .graph-container {
    height: 140px;
    margin: 1rem -2rem;
    padding: 0 2rem;
    position: relative;
  }

  #btc-chart-container {
    width: 100%;
    height: 100%;
  }

  .tracker-footer {
    border-top: 1px solid rgba(76, 157, 245, 0.2);
    padding-top: 1rem;
    margin-top: 1rem;
    display: flex;
    justify-content: center;
  }

  .last-updated {
    font-size: 0.8rem;
    color: #cbd6e6;
    font-weight: 500;
  }
</style>

<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script>
  // @ts-nocheck
  let currentChart = null;
  let currentRange = '24h';

  // Wait for LightweightCharts to be available
  function waitForLightweightCharts() {
    return new Promise((resolve) => {
      if (typeof window !== 'undefined' && window.LightweightCharts) {
        resolve(window.LightweightCharts);
      } else {
        setTimeout(() => waitForLightweightCharts().then(resolve), 100);
      }
    });
  }

  async function fetchBtcData(range = '24h') {
    const priceEl = document.getElementById('btc-price');
    const changeEl = document.getElementById('btc-change');
    const timeEl = document.getElementById('update-time');

    try {
      console.log('Fetching BTC data for range:', range);
      
      if (range === '30d') {
        // For 30 days, we need chart data from different endpoint
        console.log('Fetching 30d daily data...');
        const chartResponse = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=30&interval=daily');
        const chartData = await chartResponse.json();
        
        const basicResponse = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false');
        const basicData = await basicResponse.json();
        
        console.log('30d data received:', chartData.prices?.length, 'points');
        updateDisplay(basicData, chartData.prices, range);
        return;
      } else if (range === '1y') {
        // For 1 year, we need chart data from different endpoint
        console.log('Fetching 1y daily data...');
        const chartResponse = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=365&interval=daily');
        const chartData = await chartResponse.json();
        
        const basicResponse = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false');
        const basicData = await basicResponse.json();
        
        console.log('1y data received:', chartData.prices?.length, 'points');
        updateDisplay(basicData, chartData.prices, range);
        return;
      }
      
      // For 24h and 7d, use basic endpoint
      const url = 'https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=true';
      console.log('API URL:', url);
      
      const response = await fetch(url);
      const data = await response.json();
      
      let chartData = null;
      if (range === '24h') {
        // Get hourly data for 24h
        console.log('Fetching 24h hourly data...');
        const hourlyResponse = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1&interval=hourly');
        const hourlyData = await hourlyResponse.json();
        chartData = hourlyData.prices;
        console.log('24h data received:', chartData?.length, 'points');
      } else if (range === '7d') {
        chartData = data.market_data.sparkline_7d.price;
        console.log('7d sparkline data received:', chartData?.length, 'points');
      }
      
      updateDisplay(data, chartData, range);

    } catch (error) {
      console.error('Error fetching BTC data:', error);
      if (priceEl) priceEl.textContent = 'Error';
    }
  }

  function updateDisplay(data, chartData, range) {
    const priceEl = document.getElementById('btc-price');
    const changeEl = document.getElementById('btc-change');
    const timeEl = document.getElementById('update-time');

    const price = data.market_data.current_price.usd;
    let change;
    
    if (range === '24h') {
      change = data.market_data.price_change_percentage_24h;
    } else if (range === '7d') {
      change = data.market_data.price_change_percentage_7d;
    } else if (range === '30d') {
      change = data.market_data.price_change_percentage_30d;
    } else if (range === '1y') {
      change = data.market_data.price_change_percentage_1y;
    }
    
    if (priceEl) {
      priceEl.textContent = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(price);
    }
    
    if (changeEl && change !== undefined) {
      const isUp = change >= 0;
      changeEl.className = `price-change ${isUp ? 'up' : 'down'}`;
      changeEl.innerHTML = `
        <span class="change-icon">${isUp ? '▲' : '▼'}</span>
        <span class="change-value">${Math.abs(change).toFixed(2)}%</span>
        <span class="change-period">(${range})</span>
      `;
    }
    
    if (chartData && chartData.length > 0) {
      console.log(`Creating chart with ${chartData.length} data points, isPositive: ${change >= 0}`);
      console.log('Sample data points:', chartData.slice(0, 3));
      createChart(chartData, change >= 0);
    } else {
      console.error('No chart data available:', { chartData, range, change });
    }
    
    if (timeEl) {
      timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
  }

  async function createChart(data, isPositive) {
    const chartContainer = document.getElementById('btc-chart-container');
    
    if (!chartContainer) {
      console.error('Chart container not found');
      return;
    }

    // Wait for LightweightCharts to be available
    await waitForLightweightCharts();
    const LightweightCharts = window.LightweightCharts;

    // Clear container
    chartContainer.innerHTML = '';

    // Remove existing chart
    if (currentChart) {
      currentChart.remove();
      currentChart = null;
    }
    
    // Create new chart
    currentChart = LightweightCharts.createChart(chartContainer, {
      width: chartContainer.clientWidth,
      height: chartContainer.clientHeight,
      layout: {
        background: { color: 'transparent' },
        textColor: '#cbd6e6',
        fontSize: 10,
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
      },
      grid: {
        vertLines: { color: 'rgba(76, 157, 245, 0.1)' },
        horzLines: { color: 'rgba(76, 157, 245, 0.1)' },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
        vertLine: {
          color: 'rgba(76, 157, 245, 0.3)',
          width: 1,
          style: LightweightCharts.LineStyle.Dashed,
        },
        horzLine: {
          color: 'rgba(76, 157, 245, 0.3)',
          width: 1,
          style: LightweightCharts.LineStyle.Dashed,
        },
      },
      rightPriceScale: {
        borderColor: 'rgba(76, 157, 245, 0.2)',
        textColor: '#cbd6e6',
      },
      timeScale: {
        borderColor: 'rgba(76, 157, 245, 0.2)',
        textColor: '#cbd6e6',
        timeVisible: true,
        secondsVisible: false,
      },
      overlayPriceScales: {
        ticksVisible: false,
        borderVisible: false,
      },
      localization: {
        priceFormatter: (price) => {
          return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        },
      },
    });

    // Convert data format for LightweightCharts
    console.log('Raw data sample:', data.slice(0, 2));
    
    const chartDataPoints = data.map(([timestamp, value]) => ({
      time: Math.floor(timestamp / 1000), // Convert to seconds
      value: Number(value),
    }));

    console.log('Processed data points:', chartDataPoints.slice(0, 2));
    console.log('Chart container dimensions:', {
      width: chartContainer.clientWidth,
      height: chartContainer.clientHeight
    });

    // Add area series
    const areaSeries = currentChart.addAreaSeries({
      topColor: isPositive ? 'rgba(74, 222, 128, 0.3)' : 'rgba(248, 113, 113, 0.3)',
      bottomColor: 'transparent',
      lineColor: isPositive ? '#4ade80' : '#f87171',
      lineWidth: 2,
      priceFormat: {
        type: 'price',
        precision: 0,
        minMove: 1,
      },
    });

    await areaSeries.setData(chartDataPoints);
    console.log('Chart data set successfully');

    // Fit content
    try {
      currentChart.timeScale().fitContent();
      console.log('Chart fitted to content');
    } catch (error) {
      console.error('Error fitting chart content:', error);
    }

    // Handle resize
    window.addEventListener('resize', () => {
      if (currentChart) {
        currentChart.applyOptions({
          width: chartContainer.clientWidth,
        });
      }
    });

    // Force a render after a short delay to ensure visibility
    setTimeout(() => {
      if (currentChart) {
        currentChart.timeScale().fitContent();
        console.log('Chart render forced');
      }
    }, 100);
  }

  // Time range button handlers
  function setupTimeRangeButtons() {
    const buttons = document.querySelectorAll('.time-range-btn');
    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        // Remove active class from all buttons
        buttons.forEach((b) => b.classList.remove('active'));
        // Add active class to clicked button
        btn.classList.add('active');
        // Update current range and fetch new data
        currentRange = btn.dataset.range;
        fetchBtcData(currentRange);
      });
    });
  }

  // Initialize everything
  async function initialize() {
    try {
      // Wait for LightweightCharts library
      await waitForLightweightCharts();
      
      // Setup buttons
      setupTimeRangeButtons();
      
      // Initial data fetch
      console.log('Fetching initial BTC data for range: 24h');
      await fetchBtcData('24h');
      
      // Set up periodic updates
      setInterval(() => {
        console.log('Updating BTC data for range:', currentRange);
        fetchBtcData(currentRange);
      }, 60000);
      
    } catch (error) {
      console.error('Error initializing BTC tracker:', error);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
</script>